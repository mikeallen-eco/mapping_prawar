---
title: "The 'Mapping Warbler Song' Project - part 2"
author: "Mike Allen"
date: "April 2023"
output: html_document
---
# Load libraries and read in your data file
This code file is organized into discrete "chunks" each of which can be run by clicking its green arrow. Make sure the "prawar_class_data_2023.csv" file is in your "my_data" folder. The first chunk of code reads in the compiled class data, keeping only songs with a known location (latitude/longitude) and with a quality score of 4 or greater.
```{r}
# load the function libraries called "dplyr", "ggplot2", and "sf"
# note: this also installs them if they are not yet installed
if (require("dplyr") == F) {
  install.packages("dplyr")
}
if (require("ggplot2") == F) {
  install.packages("ggplot2")
}
if (require("sf") == F) {
  install.packages("sf")
}
if (require("viridis") == F) {
  install.packages("viridis")
}

library(dplyr)
library(ggplot2)
library(sf)
library(viridis)

# create a "my_data" folder if none exists
if(!dir.exists("my_data")){dir.create("my_data")}

# read in the compiled class data that you put into your "my_data" folder
  # also add map 4x4 lat/lon "grid cell" information to the data
my_data <- read.csv("my_data/prawar_class_data_2023.csv") %>%
  mutate(lat = trunc(Latitude), lon = trunc(Longitude)) %>%
  mutate(grid_lat = case_when(lat %in% 30:33 ~ 32,
                              lat %in% 34:37 ~ 36,
                              lat %in% 38:41 ~ 40,
                              lat %in% 42:45 ~ 44,
                              lat %in% 46:49 ~ 48),
         grid_lon = case_when(lon %in% -66:-69 ~ -68,
                              lon %in% -70:-73 ~ -72,
                              lon %in% -74:-77 ~ -76,
                              lon %in% -78:-81 ~ -80,
                              lon %in% -82:-85 ~ -84,
                              lon %in% -86:-89 ~ -88,
                              lon %in% -90:-93 ~ -92,
                              lon %in% -94:-97 ~ -96),
         grid = paste0(grid_lat, grid_lon)
                              ) %>%
  select(-lat,-lon)

# load the map of North America
state_bounds <- readRDS("map_data/prawar_map.rds")
```
# View and explore the compiled class data
QUESTION 5: How many rows and columns does it have?
QUESTION 6: What is the average number of syllables? The min? The max?
```{r}
# view the data base
View(my_data)

# view the mean and quantiles of the syllable number data
summary(my_data$num_syllables)

# make a histogram of the syllable number data
hist(my_data$num_syllables)
```
# Summarize the data by grid cell
```{r}
# summaize data by grid cell
sum_data <- my_data %>%
  group_by(grid, grid_lat, grid_lon) %>%
  summarize(num_syllables = mean(num_syllables),
            freq_range_khz = mean(2*freq_range_mm/two_khz_mm),
            duration_s = mean(2*duration_mm/two_sec_mm),
            n = length(grid_lat),
            .groups = "drop")

View(sum_data)
```

# Make map of the mean syllables per song
We exclude grid cells with fewer than 5 songs.
QUESTION 7: Do you see any patterns in mean number of syllables?
```{r}
sum_data %>%
  filter(n >= 5) %>%
    ggplot() +
  geom_sf(data = state_bounds, aes(), color = "gray",
          size = .25) +
  geom_tile(aes(x = grid_lon, y = grid_lat, fill = num_syllables), 
                 size = 1) +
  scale_fill_viridis(option = "inferno") +
  theme_bw() + 
  theme(text = element_text(size = 14)) +
  labs(x = "", y = "",
       fill = "Mean\nnumber",
       title = "Number of syllables")

ggsave("my_output/Fig1_mean_num_syllables.png", 
       height = 5, width = 5, dpi = 400)
```
# Make map of the mean frequency range per song
We exclude grid cells with fewer than 5 songs.
QUESTION 8: Do you see any patterns in mean frequency range?
```{r}
sum_data %>%
  filter(n >= 5) %>%
    ggplot() +
  geom_sf(data = state_bounds, aes(), color = "gray",
          size = .25) +
  geom_tile(aes(x = grid_lon, y = grid_lat, fill = freq_range_khz), 
                 size = 1) +
  scale_fill_viridis(option = "inferno") +
  theme_bw() + 
  theme(text = element_text(size = 14)) +
  labs(x = "", y = "", fill = "Mean\nrange\n(kHz)",
       title = "Frequency range")

ggsave("my_output/Fig2_mean_freq_range_khz.png", 
       height = 5, width = 5, dpi = 400)
```
# Make map of the mean song duration
We exclude grid cells with fewer than 5 songs.
QUESTION 10: Do you see any patterns in mean song duration?
```{r}
sum_data %>%
  filter(n >= 5) %>%
    ggplot() +
  geom_sf(data = state_bounds, aes(), color = "gray",
          size = .25) +
  geom_tile(aes(x = grid_lon, y = grid_lat, fill = duration_s), 
                 size = 1) +
  scale_fill_viridis(option = "inferno") +
  theme_bw() + 
  theme(text = element_text(size = 14)) +
  labs(x = "", y = "", fill = "Mean\nduration\n(s)",
       title = "Song duration")

ggsave("my_output/Fig3_mean_song_duration_s.png", 
       height = 5, width = 5, dpi = 400)
```
# Challenge: make a map of the mean trill rate (syllables / second)
Copy / paste and modify the code in the previous chunk to make the 4th "challenge" map.
```{r}


```